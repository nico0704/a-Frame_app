<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Aufgabe 3</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
</head>

<body>
    <a-scene background="color: black">
        <a-entity light="intensity: 0.6; castShadow: true" position="-0.5 1 1" data-aframe-default-light=""
            aframe-injected=""></a-entity>
        <a-entity class="trackLimits">
            <!--Street plane-->
            <a-plane position="0 0 -2" rotation="-90 0 0" width="15" height="120" color="#343434"></a-plane>
        </a-entity>
        <!--Car_1-->
        <a-entity class="car" scale="2.47 0.92 0.5" position="2.85 0 -55"
            animation="property: object3D.position.z; to:80; delay: 200; dur: 5200; easing: linear; loop: true">
            <!--Body-->
            <a-cylinder position="1 1.05 -10" rotation="90 -90 0" scale="2.0 0.6 0.6" radius="2" segments-radial="10"
                color="#253aa7"></a-cylinder>
            <!--Windshield-->
            <a-plane position="0.997 1.65 -6.735" scale="0.6 1.13 1" rotation="-67.5 0 0" color="#6a747c" height="1"
                width="1" metalness="0.7"></a-plane>
            <!--Tires-->
            <a-sphere position="0.7 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="0.7 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <!--Lights-->
            <a-sphere position="0.794 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
            <a-sphere position="1.2 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
        </a-entity>
        <!--Car_2-->
        <a-entity class="car" scale="2.47 0.92 0.5" position="-4.68 0 -55"
            animation="property: object3D.position.z; to:80; delay: 200; dur: 5200; easing: linear; loop: true">
            <!--Body-->
            <a-cylinder position="1 1.05 -10" rotation="90 -90 0" scale="2.0 0.6 0.6" radius="2" segments-radial="10"
                color="#752b19"></a-cylinder>
            <!--Windshield-->
            <a-plane position="0.997 1.65 -6.735" scale="0.6 1.13 1" rotation="-67.5 0 0" color="#6a747c" height="1"
                width="1" metalness="0.7"></a-plane>
            <!--Tires-->
            <a-sphere position="0.7 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="0.7 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <!--Lights-->
            <a-sphere position="0.794 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
            <a-sphere position="1.2 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
        </a-entity>
        <!--Car_3-->
        <a-entity class="car" scale="2.47 0.92 0.5" position="-0.28 0 -55"
            animation="property: object3D.position.z; to:80; delay: 2600; dur: 5200; easing: linear; loop: true">
            <!--Body-->
            <a-cylinder position="1 1.05 -10" rotation="90 -90 0" scale="2.0 0.6 0.6" radius="2" segments-radial="10"
                color="#df5891"></a-cylinder>
            <!--Windshield-->
            <a-plane position="0.997 1.65 -6.735" scale="0.6 1.13 1" rotation="-67.5 0 0" color="#6a747c" height="1"
                width="1" metalness="0.7"></a-plane>
            <!--Tires-->
            <a-sphere position="0.7 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="0.7 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <!--Lights-->
            <a-sphere position="0.794 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
            <a-sphere position="1.2 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
        </a-entity>
        <!--Car_4-->
        <a-entity class="car" scale="2.47 0.92 0.5" position="-7.96 0 -55"
            animation="property: object3D.position.z; to:80; delay: 2600; dur: 5200; easing: linear; loop: true">
            <!--Body-->
            <a-cylinder position="1 1.05 -10" rotation="90 -90 0" scale="2.0 0.6 0.6" radius="2" segments-radial="10"
                color="#221b19"></a-cylinder>
            <!--Windshield-->
            <a-plane position="0.997 1.65 -6.735" scale="0.6 1.13 1" rotation="-67.5 0 0" color="#6a747c" height="1"
                width="1" metalness="0.7"></a-plane>
            <!--Tires-->
            <a-sphere position="0.7 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -6.95" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="0.7 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <a-sphere position="1.313 0.25 -13.2" scale="0.25 1 1" color="#101116" radius="0.3"></a-sphere>
            <!--Lights-->
            <a-sphere position="0.794 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
            <a-sphere position="1.2 0.949 -6.255" scale="0.69 1 1" color="#c47327" emissive="#655c49"
                radius="0.11"></a-sphere>
        </a-entity>
        <a-plane position="0 0 -58" rotation="0 0 0" width="16" height="20" color="black" metalness="1"></a-plane>
        <!--Scoreboard-->
        <a-entity>
            <!--<a-plane position="0 20 -40.1" rotation="25 0 0" color="#6a747c" width="30" height="13"></a-plane>-->
            <a-text id="scoreboard" value="" position="25 20 -50" rotation="30 -40 0" scale="1.2 1.2 1.2" color="white"
                font="mozillavr" width="22.5" height="25"></a-text>
        </a-entity>
        <!--Title-->
        <a-entity>
            <a-text value="VRace" position="-9 2.5 -50" rotation="0 0 0" scale="5 5 5" color="#d61313" font="roboto"
                width="25" height="25" letterSpacing="10"></a-text>
        </a-entity>
    </a-scene>
</body>
<script>
    var sceneEl = document.querySelector('a-scene');
    let cars = document.querySelectorAll(".car");

    window.addEventListener("load", getScore);
    window.addEventListener("load", setCars);
    window.addEventListener("load", drawTrackLimits);

    function getScore() {
        console.log("getting data from database...");
        let xhr = new XMLHttpRequest();
        xhr.open("GET", "/getScore", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onload = function () {
            if (this.status == 200) {
                let response = JSON.parse(xhr.response);
                //console.log(response);
                let score_arr = [];
                let result = "";
                response.forEach(element => {
                    score_arr.push(element);
                });
                // sort array by score (descending)...
                score_arr.sort((a, b) => b.score - a.score);
                console.log(score_arr);
                let pos = 1;
                score_arr.forEach(element => {
                    result += pos + ". " + element.firstname + " " + element.lastname + " - " + element.gamertag + " : " + element.score + "\n";
                    pos++;
                })
                document.getElementById("scoreboard").setAttribute("value", result);
                document.getElementById("scoreboard").setAttribute("text", { lineHeight: "150", letterSpacing: "7.5" });
            } else {
                console.log("could not get data from database!");
            }
        }
        xhr.send();
    }

    function setCars() {
        const colors = ["#253aa7", "#752b19", "#df5891", "#221b19", "#d6e7f1", "#cf1f21", "#333a3c"];
        for (let i = 0; i < cars.length; i++) {
            if (cars[i].getAttribute("position").z > 70) {
                //console.log(cars[i].getAttribute("position"))
                let car = cars[i];
                let x = car.getAttribute("position").x;
                car.setAttribute("position", { x: x, y: 0, z: -55 });
                car.setAttribute("animation", {
                    property: "object3D.position.z",
                    to: "80",
                    dur: randomIntFromInterval(3000, 5600),
                    easing: "linear",
                    loop: true,
                });
                car.childNodes[3].setAttribute("material", { color: colors[randomIntFromInterval(0, 6)] });
            }
        }
        setTimeout(() => {
            requestAnimationFrame(setCars);
        }, 250);
    }

    function drawTrackLimits() {
        let trackLimits = document.querySelector(".trackLimits");
        for (let i = 0; i < 60; i++) {
            let right_track_limit = document.createElement("a-plane");
            let left_track_limit = document.createElement("a-plane");
            left_track_limit.setAttribute("position", { x: 7.5, y: 0.01, z: (-60 + 2 * i) });
            left_track_limit.setAttribute("rotation", { x: -90, y: 0, z: 0 });
            left_track_limit.setAttribute("material", { color: "#d61313" });
            right_track_limit.setAttribute("position", { x: -7.5, y: 0.01, z: (-60 + 2 * i) });
            right_track_limit.setAttribute("rotation", { x: -90, y: 0, z: 0 });
            right_track_limit.setAttribute("material", { color: "#d61313" });
            trackLimits.appendChild(left_track_limit);
            trackLimits.appendChild(right_track_limit);
        }
        for (let i = 0; i < 60; i++) {
            let right_track_limit = document.createElement("a-plane");
            let left_track_limit = document.createElement("a-plane");
            left_track_limit.setAttribute("position", { x: 7.5, y: 0.01, z: (-61 + 2 * i) });
            left_track_limit.setAttribute("rotation", { x: -90, y: 0, z: 0 });
            left_track_limit.setAttribute("material", { color: "#b3afaf" });
            right_track_limit.setAttribute("position", { x: -7.5, y: 0.01, z: (-61 + 2 * i) });
            right_track_limit.setAttribute("rotation", { x: -90, y: 0, z: 0 });
            right_track_limit.setAttribute("material", { color: "#b3afaf" });
            trackLimits.appendChild(left_track_limit);
            trackLimits.appendChild(right_track_limit);
        }
        for (let i = 0; i < 12; i++) {
            let road_marking = document.createElement("a-plane");
            road_marking.setAttribute("position", { x: 0, y: 0.01, z: (-55 + 10 * i) });
            road_marking.setAttribute("rotation", { x: -90, y: 0, z: 0 });
            road_marking.setAttribute("material", { color: "#b3afaf" });
            road_marking.setAttribute("geometry", { height: "5", width: "1" });
            trackLimits.appendChild(road_marking);
        }
    }

    function randomIntFromInterval(min, max) {
        // min and max included
        return Math.floor(Math.random() * (max - min + 1) + min);
    }

</script>

</html>